<!DOCTYPE html>
<html> 
  <head> 
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8"> 
    <!--The viewport meta tag is used to improve the presentation and behavior of the samples 
      on iOS devices-->
    <meta name="viewport" content="initial-scale=1, maximum-scale=1,user-scalable=no">
    <title>AR Fire Districts</title> 

    <!--link rel="stylesheet" href="http://js.arcgis.com/3.8/js/dojo/dijit/themes/claro/claro.css"--> 
    
	<style type="text/css">
		@import  "http://js.arcgis.com/3.4/js/dojo/dijit/themes/claro/claro.css";
		@import "http://js.arcgis.com/3.7/js/esri/css/esri.css";
		@import "http://js.arcgis.com/3.4/js/dojo/dojox/layout/resources/FloatingPane.css";
		@import "http://js.arcgis.com/3.4/js/dojo/dojox/layout/resources/ResizeHandle.css";
	</style>
    <link rel="stylesheet" href="home/css/HomeButton.css">
    <link rel="stylesheet" href="css/mapinfofp.css">
    <link rel="stylesheet" href="css/prninfo.css">
    <link rel="stylesheet" href="css/overview.css">
    <link rel="stylesheet" href="css/ArFire.css">
    <style>
        #HomeButton {
          position: absolute;
          top: 82px;
          left: 20px;
          z-index: 50;
        }
        
        #MapInfo {
          position: absolute;
          top: 145px;
          left: 20px;
          z-index: 50;
        }
        
        #PrintInfo {
          position: absolute;
          top: 177px;
          left: 20px;
          z-index: 50;
        }
        
        #OverviewInfo {
          position: absolute;
          top: 114px;
          left: 20px;
          z-index: 50;
        }
        
		html, body, #mapDiv {
			padding:0;
			margin:0;
			height:100%;
			width:100%;
		}
	  
		/* floating pane */
		.dojoxFloatingPaneWrapper {
			padding:8px;
		}
		.dojoxFloatingPane {
			padding:0 !important;
			border:solid 1px #eee !important;
		}
		.dojoxFloatingPaneTitle {
			border: 1px solid #ffffff;
			border-top: none;
			background-color: #eee;
			background-image: url("http://ajax.googleapis.com/ajax/libs/dojo/1.9.1/dijit/themes/claro/images/standardGradient.png");
			background-repeat: repeat-x;
			background-image: -moz-linear-gradient(rgba(255, 255, 255, 0.7) 0%, rgba(255, 255, 255, 0) 100%);
			background-image: -webkit-linear-gradient(rgba(255, 255, 255, 0.7) 0%, rgba(255, 255, 255, 0) 100%);
			background-image: -o-linear-gradient(rgba(255, 255, 255, 0.7) 0%, rgba(255, 255, 255, 0) 100%);
			background-image: linear-gradient(rgba(255, 255, 255, 0.7) 0%, rgba(255, 255, 255, 0) 100%);
			_background-image: none;
			padding: 5px 7px 4px 7px;
		}
		.dojoxFloatingPaneContent {
			border-top:solid 1px #769DC0;
			padding:0;
			overflow:hidden
		}
		.dojoxFloatingMinimizeIcon {
			/*custom minimize icon if desired*/
		}
		.shadow {
            -moz-border-radius:6px;
            -webkit-border-radius:6px;
             border-radius:6px;
            -moz-box-shadow:0 6px 3px -3px #888;
            -webkit-box-shadow:0 6px 3px -3px #888;
            box-shadow:0 6px 3px -3px #888;
            background-color:#FFF;
            border:solid 4px #eee;
            padding:8px;
        }
        .dojoxDock {
            display: block;
            border: 4px solid black;
            position: absolute;
            padding: 0;
            margin: 0;
            background: darkgray;
            width:80%;
        }
    </style>
	<script type="text/javascript">
		/*var dojoConfig = {
			parseOnLoad: false,
			async: true,
			packages: [{
				name: "floatpane",
				"location": location.pathname.replace(/\/[^/]+$/, "")+'/floatpane' // may need to revise it based on your project file structure
			}]
		};*/
		var package_path = window.location.pathname.substring(0, window.location.pathname.lastIndexOf('/'));
			var dojoConfig = {
				// The locationPath logic below may look confusing but all its doing is 
				// enabling us to load the api from a CDN and load local modules from the correct location.
				packages: [{
					name: "modules",
					location: package_path + '/home/js'
				}, {
					name: "zesri",
					location: package_path + '/home/js'
				}]
		};
	</script>
    <script src="http://js.arcgis.com/3.6/"></script> 
    <script> 
		var map;
		var initialExtent;
		var floatPane;
		var mapinfofp;
		var printinfofp;
		var theStore;
		var countyStore;
		var overviewMap;
      require([
        "esri/map", 
        "esri/dijit/OverviewMap",
		"esri/geometry/Extent", 
		"esri/tasks/IdentifyTask", 
		"esri/tasks/IdentifyParameters", 
		"esri/SpatialReference", 
		"esri/InfoTemplate", 
		"esri/dijit/Popup", 
		"esri/symbols/SimpleFillSymbol",
		"esri/symbols/SimpleLineSymbol",
		"dijit/form/Button", 
		"esri/layers/ArcGISDynamicMapServiceLayer", 
		"esri/layers/FeatureLayer",
		"esri/toolbars/navigation",
		
		"modules/HomeButton",
		"dojox/layout/Dock",
		"dojox/layout/ResizeHandle",
		"dijit/layout/AccordionContainer",
		"dojox/layout/ContentPane",
		"dijit/form/FilteringSelect",
		"dojo/parser",
		"dojox/layout/FloatingPane",
		"esri/dijit/Print",
		"esri/tasks/QueryTask",
		"esri/tasks/query",
		"esri/tasks/FindTask",
		"esri/tasks/FindParameters",
		"dojo/data/ItemFileReadStore",
		"dojo/dom",
		"dojo/query",
		"dojo/dom-attr",
		"dijit/form/RadioButton",
		"dojo/fx/Toggler",
		"dojo/on",
		"dojo/_base/declare",
		"dojo/domReady!"
      ], function(
        Map, OverviewMap, InitialExtent, IdentifyTask, IdentifyParameters, SpatialReference, InfoTemplate, Popup, SimpleFillSymbol, SimpleLineSymbol, Button, ArcGISDynamicMapServiceLayer, FeatureLayer, Navigation,
		HomeButton, Dock, ResizeHandle, AccordionContainer, ContentPane, FilteringSelect, parser, FloatingPane, Print, QueryTask, query, FindTask, FindParameters, ItemFileReadStore, dom,
		djQuery, domAttr, RadioButton, Toggler, on, declare
      ) {
        parser.parse();
			
		
		initialExtent = new InitialExtent(172209.475904854, 3601359.1077277837, 985642.8725089643,  4064083.0555859907, new SpatialReference({
                    wkid: 26915  
        }));
		
        map = new Map("mapDiv", { 
		  logo:false,
		  extent: initialExtent,//basemap: "national-geographic",
          //center: [-96.541, 38.34],
          zoom: 6
        });
		
        var ConstrainedFloatingPane = declare(FloatingPane, {
            
            postCreate: function() {
                this.inherited(arguments);
                this.moveable = new dojo.dnd.move.constrainedMoveable(
                    this.domNode, {
                        handle: this.focusNode,
                        constraints: function() {
                            var coordsBody = dojo.coords(dojo.body());
                            // or
                            var coordsWindow = {
                                l: 0,
                                t: 0,
                                w: window.innerWidth,
                                h: window.innerHeight                            
                            };
                            
                            return coordsWindow;
                        },
                        within: true
                    }
                );                            
            }
            
        });		
        
		var infoTemplate = new InfoTemplate("${NAME10}", "County:  ${NAME10}");
		
		var Ar_Fire_Distrcts = new ArcGISDynamicMapServiceLayer("http://argis.ualr.edu/ieagis/rest/services/Ar_Fire_Distrcts/MapServer", {
			id: 'Ar_Fire_Distrcts',
			outFields: ["*"],
			infoTemplate: infoTemplate,
			opacity: 0.8
		});        
			
		map.on("load", initOperationalLayer);
		map.addLayer(Ar_Fire_Distrcts);
		map.on("click", executeIdentifyTask);
		s1=dojo.byId('srchTool');
		
        function initOperationalLayer() {
		    toggler.hide();
		    
			var navToolbar = new Navigation(map);
			
			var zoomInDiv = djQuery(".esriSimpleSliderIncrementButton");
			domAttr.set(zoomInDiv[0],"title","Zoom in");
			  
			var zoomOutDiv = djQuery(".esriSimpleSliderDecrementButton");
			domAttr.set(zoomOutDiv[0],"title","Zoom out");
			
			//Create Find Task using Post code layer
			findTask = new FindTask("http://argis.ualr.edu/ieagis/rest/services/Ar_Fire_Distrcts/MapServer");
			//Create the find parameters
			findParams = new FindParameters();
			findParams.returnGeometry = true;
			findParams.outSpatialReference = map.spatialReference;
			
			//floating window for map search
			mapinfofp = new FloatingPane({
			  id: 'mapinfofp',
			  title: 'Search',
			  resizable: false,
			  //resizeAxis: null,
			  closable: false,
			  dockable: false,
			  dockTo: dojox.layout.dock,
			  style: 'position:absolute;bottom:250px;left:20px;width:370px;height:135px;visibility:hidden;overflow:hidden;',
			  href: 'accord.html',
			  //content: dom.byId('mapinfofpp'),
			  preload: true
			},dojo.byId("mapinfofp"));

			
			mapinfofp.on('load', function(){			
			    queryDistTask = new QueryTask("http://argis.ualr.edu/ieagis/rest/services/Ar_Fire_Distrcts/MapServer/1");
    			//build query filter
    			queryDist = new query();
    			queryDist.returnGeometry = false;
    			queryDist.outFields = ["OBJECTID_1","NAME"];
    			runDistQuery();
    			
    			queryTask = new esri.tasks.QueryTask("http://argis.ualr.edu/ieagis/rest/services/Ar_Fire_Distrcts/MapServer/2");
    			//build query filter
				query = new query();
				query.returnGeometry = false;
				query.outFields = ["OBJECTID","NAME10"];					
				runQuery();	

			});		

			mapinfofp.on('show', function () {
			        domAttr.set("mmpp","style","background-color:#ccc");
				    mapinfofp.bringToTop();
			});

			
			//floating window for print
			printinfofp = new FloatingPane({
			  id: 'printinfofp',
			  title: 'Print',
			  resizable: false,
			  //resizeAxis: null,
			  closable: false,
			  dockable: false,
			  dockTo: dojox.layout.dock,
			  style: 'position:absolute;bottom:60px;left:20px;width:370px;height:200px;visibility:hidden;overflow:hidden;',
			  href: 'printer.html',
			  //content: dom.byId('mapinfofpp'),
			  preload: true
			},dojo.byId("printinfofp"));

			printinfofp.on('show', function () {
			        domAttr.set("print","style","background-color:#ccc");
				    printinfofp.bringToTop();
			});
			
			printinfofp.on('load', function(){			
				createPrintDijit(dojo.byId('map_name').value);
				printinfofp.bringToTop();
			});	
			
			overviewMap = new OverviewMap({
                map: map,
                attachTo: "bottom-right",
                expandFactor: 3,
                visible: false
            }, dojo.byId("overviewDiv"));
            overviewMap.startup();
            //overviewMap.hide();
			//dojo.connect(searchDistButton,"onclick",setDistPrintTitle);	
        }
        var home = new HomeButton({
          map: map
        }, "HomeButton");
        home.startup();
        
        var toggler = new Toggler({
            node: "ovWin"
          });
          
          on(dom.byId("expandOV"), "click", function(e){
            toggler.show();
            domAttr.set("expandOV","style","visibility:hidden");
            domAttr.set("collapseOV","style","visibility:visible");
          });
          on(dom.byId("collapseOV"), "click", function(e){
            toggler.hide();
            domAttr.set("expandOV","style","visibility:visible");
            domAttr.set("collapseOV","style","visibility:hidden");
          });
         on (dom.byId("overview"),"click", function(e){
             if(dojo.style("collapseOV", "visibility") == "visible"){
                 collapseOV.click();
             }else{
                expandOV.click();

             }  
         });
         
         var srchToggler = new Toggler({
            node: "mapinfofp"
          });
          
          on(dom.byId("mmpp"), "click", function(e){
             if(dojo.style("mapinfofp", "visibility") == "visible"){
                 mapinfofp.hide();
                 domAttr.set("mmpp","style","background-color:fff");
             }else{
                mapinfofp.show();
             }    
          });
          
          var printToggler = new Toggler({
            node: "printinfofp"
          });
          
          on(dom.byId("print"), "click", function(e){
             if(dojo.style("printinfofp", "visibility") == "visible"){
                 printinfofp.hide();
                 domAttr.set("print","style","background-color:fff");
             }else{
                printinfofp.show();
             }    
          });
          /*on(dom.byId("collapseOV"), "click", function(e){
            toggler.hide();
            domAttr.set("expandOV","style","visibility:visible");
            domAttr.set("collapseOV","style","visibility:hidden");
          });*/
         
        //create the radio buttons to toggle between the school district search and the city search
         /* var radpar = new RadioButton({
              checked: true,
              value: "distDiv",
              name: "searchParam",
              onChange: function (b) { if (b) searchToggle(this.value); }
          }, "radpar");*/
		
	    //tie the onChange events of the radio buttons to toggle between the school district and city
         /* dijit.byId('radpar').on('change', function () {
              var value = this.value;
          });*/
          
		function createPrintDijit(printTitle) {
				var layoutTemplate, templateNames, mapOnlyIndex, templates;
								
				// create an array of objects that will be used to create print templates
				var layouts = [
				  { 
					"name": "Letter ANSI A Landscape", 
					"label": "Landscape (PDF)", 
					"format": "pdf", 
					"options": { 
					  "legendLayers": [], // empty array means no legend
					  "scalebarUnit": "Miles",
					  "titleText": printTitle + ", Landscape PDF" 
					}
				  }, {
					"name": "Letter ANSI A Portrait", 
					"label": "Portrait (Image)", 
					"format": "jpg", 
					"options":  { 
					  "legendLayers": [],
					  "scaleBarUnit": "Miles",
					  "titleText": printTitle + ", Portrait JPG"
					}
				  },{
                    label: "Map Only (PNG)",
                    format: "PNG32",
                    layout: "MAP_ONLY",
                    preserveScale: true,
                    exportOptions: {
                      width: 1024,
                      height: 768,
                      dpi: 96
                    }
                  }
				];
				
				// create the print templates, could also use dojo.map
				var templates = [];
				dojo.forEach(layouts, function(lo) {
				  var t = new esri.tasks.PrintTemplate();
				  t.layout = lo.name;
				  t.label = lo.label;
				  t.format = lo.format;
				  t.preserveScale = false;
				  t.layoutOptions = lo.options;
				  templates.push(t);
				});

				printer = new esri.dijit.Print({
				  "map": map,
				  "templates": templates,
				  "asynch":	false,
				  url: "http://argis.ualr.edu/ieagis/rest/services/Utilities/PrintingTools/GPServer/Export%20Web%20Map%20Task"
				}, dojo.byId("printButton"));
				printer.startup();			
				dojo.connect(printer, "onPrintStart", function(){
					this.templates[0].layoutOptions.titleText = dojo.byId("map_name").value;
				});
								
		}

		function executeIdentifyTask(evt) {	
			var popup = new Popup({
				fillSymbol: new SimpleFillSymbol(SimpleFillSymbol.STYLE_SOLID, new SimpleLineSymbol(SimpleLineSymbol.STYLE_SOLID, new dojo.Color([255,0,0]), 2), new dojo.Color([255,255,0,0.25]))
			}, dojo.create("div"));			
			
			var identifyTask = new IdentifyTask("http://argis.ualr.edu/ieagis/rest/services/Ar_Fire_Distrcts/MapServer");

			var identifyParams = new IdentifyParameters();
			identifyParams.tolerance = 10;
			identifyParams.returnGeometry = true;
			identifyParams.width = map.width;
			identifyParams.height = map.height;
					
			if(evt.mapPoint){
				identifyParams.geometry = evt.mapPoint;
			}else{
				identifyParams.geometry = evt.geometry;
			}	
			identifyParams.mapExtent = map.extent;
			identifyParams.layerIds=[1,2]; //identifyParams.layerIds = [2]; //	
			var deferred = identifyTask.execute(identifyParams);

			deferred.addCallback(function(response) {     
			  // response is an array of identify result objects    
			  // Let's return an array of features.
			  return dojo.map(response, function(result) {
				var feature = result.feature;
					feature.attributes.layerName = result.layerName;
					var template = new InfoTemplate(); 
					template.setTitle(feature.attributes.layerName);
					//alert(result.layerName);
				switch (result.layerName){
					case 'County':
						template.setContent(getCountyContent);
						feature.setInfoTemplate(template);
						break;
					case 'Fire Districts':
						template.setContent(getFDContent);
						feature.setInfoTemplate(template);
						break;
					case 'Parcels':
						template.setContent(getParcelContent);
						feature.setInfoTemplate(template);
						break;							
					default:
						return false;
				}					
				return feature;
			  });
			});


			// InfoWindow expects an array of features from each deferred
			// object that you pass. If the response from the task execution 
			// above is not an array of features, then you need to add a callback
			// like the one above to post-process the response and return an
			// array of features.
			map.infoWindow.setFeatures([ deferred ]);
			if(evt.mapPoint){
				map.infoWindow.show(evt.mapPoint);
			}else{
				map.infoWindow.show(evt.geometry);
			}	
		}
		
        function runQuery(){
			query.where = "OBJECTID<>0";
			//execute query
			queryTask.execute(query, qryResults);
		}	
		function qryResults(results){
		
		//Populate the dropdown list box with unique values
			values = [];
			testVals = {};
			
			features = results.features;
			dojo.forEach (features, function(feature) {
				curName = feature.attributes.NAME10;
				if (!testVals[curName]) {
					testVals[curName] = true;
					values.push({"OBJECTID":feature.attributes.OBJECTID,"NAME10":feature.attributes.NAME10});
				}
			});
			
			dataItems = {
				   identifier: "OBJECTID",
				   label: "NAME10",
				   items: values
			};
			
			countyStore = new dojo.data.ItemFileReadStore({data:dataItems});

			dijit.byId("countySearch").set("store", countyStore);	
		}
     
		function runDistQuery(){				
			queryDist.where = "OBJECTID_1<>0";
			//execute query
			queryDistTask.execute(queryDist, qryDistResults);
		}
		function qryDistResults(results){		
			//Populate the dropdown list box with unique values
			values = [];
			testVals = {};
			
			features = results.features;
			dojo.forEach (features, function(feature) {
				curName = feature.attributes.NAME;
				if (!testVals[curName]) {
					testVals[curName] = true;
					values.push({"OBJECTID_1":feature.attributes.OBJECTID_1,"NAME":feature.attributes.NAME});
				}
			});
			
			dataItems = {
				   identifier: "OBJECTID_1",
				   label: "NAME",
				   items: values
			};
			
			theStore = new ItemFileReadStore({data:dataItems});

			dijit.byId("distSearch").set("store", theStore);	
		}	 

		function getCountyContent(graphic){
			content = "<table>";
			content += "<tr><td>County:</td><td>"+ graphic.attributes.NAME10+" </td></tr>";				
			content += "<tr><td>FIPS:</td><td>"+graphic.attributes.STATEFP10 + graphic.attributes.COUNTYFP10+" </td></tr>";				
			content += "</table>";
			return content;
		}
		
		function getFDContent(graphic){
			content = "<table>";
			content += "<tr><td>Fire District:</td><td>"+ graphic.attributes.NAME+" </td></tr>";
			content += "<tr><td>County:</td><td>"+ graphic.attributes.COUNTY+" </td></tr>";
			content +="<tr><td>LOPFI Member:</td><td>"+ graphic.attributes.LOPFI_MBR +"</td></tr>";
			content +="<tr><td>Population:</td><td>"+ graphic.attributes.Population  +"</td></tr>";
			content +="<tr><td>Area:</td><td>"+graphic.attributes.Area   +" Square Miles</td></tr>";				
			content += "</table>";
			return content;
		}
		
		function resetMap(){
			dojo.byId('map_name').value = "AR Fire Districts";
			dojo.byId('countySearch').value = "";
			dojo.byId('distSearch').value = "";			
			map.setExtent(initialExtent);
			map.graphics.clear();
			map._layers.Ar_Fire_Distrcts.setVisibleLayers([0,1,2]);
		}
 });			
</script> 
</head> 
<body class="claro">
    <!--div id="header">
		<center><br/>
			<span class="soa">Arkansas Fire Districts</span>
		</center>	
		<div id="smallBar"></div>		
	</div-->
    <div id="mapinfofp" style="position:absolute;visibility:hidden" class="dojoxFloatingPaneWrapper"></div>
    <div id="printinfofp" style="position:absolute;visibility:hidden" class="dojoxFloatingPaneWrapper"></div>
    <div id="mapDiv">
        <div id="HomeButton"></div>	
        <div class="MapInfo" role="presentation" id="MapInfo" style="display: block;">
            <div class="mapContainer" >
                <div title="Search" class="mpinfo home" id="mmpp"></div>
            </div>
        </div>
        <div class="PrintInfo" role="presentation" id="PrintInfo" style="display: block;">
            <div class="mapContainer" >
                <div title="Print" class="prninfo home" id="print"></div>
            </div>
        </div>
        <div class="OverviewInfo" role="presentation" id="OverviewInfo" style="display: block;">
            <div class="mapContainer" >
                <div title="Overview" class="overviewinfo home" id="overview"></div>
            </div>
        </div>
    </div>
    <div id="expandOV" style="visibility:visible;"><img border="1" src="img/expand-top-right.png" title="Expand Overview Map" style="position:absolute;top:0px;right:0px;z-Index:999"/></div>
    <div id="collapseOV" style="visibility:hidden;"><img border="1" src="img/collapse-top-right.png" title="Collapse Overview Map" style="position:absolute;top:0px;right:0px;z-Index:999;;"/></div>
    <div id="ovWin" class="shadow" style="position:absolute;top:0px;right:0px;z-Index:998; width:200px;height:200px;">
        <div id="overviewDiv" style="width:100%;height:100%;">
        </div>
    </div>
</body> 
</html>
